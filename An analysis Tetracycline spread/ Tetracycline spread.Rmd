

# Part I

1. Load the `ckm_nodes.csv` data into a data frame called `nodes`.  It should have 246 rows and 13 columns.  The variable `adoption_date` records the month in which the doctor began prescribing tetracycline, counting from November 1953.  If the doctor did not begin prescribing it by month 17, i.e. February 1955, when the study ended, this is recorded as `Inf`.  

```{r}
nodes <- read.csv("ckm_nodes-1.csv", as.is = TRUE)
dim(nodes)
table(nodes$adoption_date)
sum(is.na(nodes$adoption_date))
```

The table command counts the doctors who began to prescribe tetracycline in each month and it also tells us that 16 doctors never prescribed it during the duration of the study.  There are 121 doctors for which we don't know this info.

2. Create a vector which records the *index numbers* of the doctors for whom `adoption_date` is not `NA`.  Check that this vector has length 125.  Reassign `nodes` so it only contains those rows.  (Do not drop rows if they have a value for `adoption_date` but are `NA` in some other column.)  Use this cleaned version of `nodes` for the rest of the homework.

```{r}
NAdocs <- which(is.na(nodes$adoption_date))
length(NAdocs)
nodes  <- nodes[-NAdocs, ]
```

3. Create a plot of the number of doctors who began prescribing tetracycline each month versus time.  (The number on the x-axis can be integers instead of formatted dates.)  Produce another plot of the *total* number of doctors prescribing tetracycline in each month.  The curve for total adoptions should first rise rapidly and then level out around month 6.

```{r}
month.info <- table(nodes$adoption_date)[1:17]
plot(names(month.info), month.info, xlab = "Month Number", ylab = "Number of Doctors", main = "Doctors Beginning to Prescribe Each Month")
plot(names(month.info), cumsum(month.info), xlab = "Month Number", ylab = "Number of Doctors", main = "Total Doctors Prescribing Each Month")
```

4. Create a logical vector which indicates for each doctor whether they had begun prescribing tetracycline by month 2.  Convert it to a vector of index numbers.  There should be twenty such doctors.  Create a Boolean vector which indicates for each doctor whether they began prescribing tetracycline after month 14. 

```{r}
month2 <- nodes$adoption_date <= 2
head(month2)
month2 <- which(month2)
head(month2)
length(month2)

month14 <- nodes$adoption_date > 14
head(month14)
month14 <- which(month14)
head(month14)
length(month14)
```

5. Write a function `adopters` which takes two arguments, `month`, with no default value and `not.yet` defaulting to `FALSE`.  If `not.yet` is `FALSE`, `adopters` should return a logical value, indicating the doctors who began prescribing tetracycline in that month.  If `not.yet` is `TRUE`, then `adopters` should return the vector indicating the doctors who began prescribing tetracycline `after` that month (or never did).  Check that `adopters(2)` indicates 9 doctors began prescribing in month 2, and that `adopters(month = 14, not.yet = TRUE)` indicates that 23 doctors began prescribing after month 14, or never did.

```{r}
adopters <- function(month, not.yet = FALSE) {
  if (not.yet) {
    return(which(nodes$adoption_date > month))
  } else {
    return(which(nodes$adoption_date == month))
  }
}
length(adopters(2))
length(adopters(month = 14, not.yet = TRUE))
```

# Part II

6. The file `ckm_network.txt` contains a binary matrix; the entry in row $i$, column $j$ is 1 if doctor number $i$ said that doctor $j$ is a friend or close professional contact, and 0 otherwise.  Load the file into `R` and call it `network`.  Verify that gives you a square matrix which contains only 1s and 0s with 246 rows and columns.  Drop the rows and columns corresponding to doctors with missing `adoption_date` values.  Check that the result has 125 rows and columns.  Use this reduced matrix, and its rows and column numbers for the rest of the homework.

```{r}
network <- read.table("ckm_network-1.txt", as.is = TRUE, header = FALSE)
dim(network)
network <- network[-NAdocs, -NAdocs]
dim(network)
```

7. Create a vector which stores the number of contacts each doctor has.  Do not use a loop.  Check that doctor number 41 has 3 contacts.

```{r}
doc.contacts <- rowSums(network)
doc.contacts[41]
```

8. Create a Boolean vector which indicates, for each doctor, whether they were contacts of doctor 37, *and* had begun prescribing tetracycline by month 5.  Count the number of such doctors without converting the Boolean vector to a vector of indices.  There should be three such doctors.  What proportion of doctor 37's friends do those three doctors represent?

```{r}
contact37 <- as.logical(network[, 37]) & nodes$adoption_date <= 5
sum(contact37)
sum(contact37)/doc.contacts[37]
```
The proportion is $0.6$.

9. Write a function `count_peer_pressure` which takes in the index number of a doctor and a month and returns the number of doctors whom that doctor names as contacts, *and* had begun prescribing tetracycline by that month or earlier.  If it is working properly, doctor number 37 and month 5 should return 3.

```{r}
count_peer_pressure <- function(index, month) {
  contacts <- network[, index] & nodes$adoption_date <= month
  return(sum(contacts))
}
count_peer_pressure(37, 5)
```

10. Write a function `prop_peer_pressure` which takes in the index number of a doctor and a month and returns the proportion of the doctor's contacts who are already prescribing tetracycline by that month.  If a doctor has no contacts, your function should return `NaN`.  Check that doctor 37, month 5 returns a proportion of 0.6, but doctor 102 in month 14 returns `NaN`.  Your function should call, not repeat, your function from (8) and use your vector from (6).

```{r}
prop_peer_pressure <- function(index, month) {
  if (doc.contacts[index] == 0) {
    return(NaN)
  } else {
    return(count_peer_pressure(index, month)/doc.contacts[index])
  }  
}
prop_peer_pressure(37, 5)
prop_peer_pressure(102, 14)
```

11.  Write a function which takes in a month and returns a vector of length 2.  The first element of the returned value should be the average proportion of prescribers among contacts of doctors who `began` prescribing in that month.  The other should be the average proportion of prescribers among contacts of doctors who began prescribing \emph{later}, or never.  Call your code from (4) and (9); avoid using a loop.

```{r}
 viral <- function(month) {
   v1 <- mean(sapply(adopters(month), prop_peer_pressure, month), na.rm = TRUE)
   v2 <- mean(sapply(adopters(month, not.yet = TRUE), prop_peer_pressure, month), na.rm = TRUE)
   return(c(v1, v2))
 }
```

12. Plot the average proportions from (10) over time.  Do not use a loop.  Do the doctors who adopt in a given month consistently have more contacts who are already prescribing than non-adopters?

```{r}
prop1  <- sapply(1:17, viral)[1,]
prop2  <- sapply(1:17, viral)[2,]
plot(1:17, prop1, type = "l", xlab = "Month")
points(1:17, prop2, type = "l", col = "red")
legend("topleft", c("Adopt", "Not Yet"), fill = c(1,2), cex = .5)
```

It's not consistent that those beginning to prescribe have more contacts than those who aren't mainly because the proportions for those beginning to prescribe each month are highly variable.
